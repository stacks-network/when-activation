<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wen 3.2 HardFork?</title>

  <style>
    :root {
      color-scheme: light dark;
    }

    body {
      color: light-dark(#000000, #ffffff);
      background-color: light-dark(#ffffff, #000000);
      padding: 0 12px;
      /* sans-serif font? */
      /* font-family: system-ui, sans-serif; */
    }
  </style>
</head>

<body>
  <h1>Wen 3.2 HardFork?</h1>

  <div id="main" hidden>
    <p>Current block is <span id="current_block"></span>.</p>
    <p>
      A first-order estimation of 3.2 epoch start is:
      <span id="expected_date"></span>.
    </p>
    <p></p>
    <p>
      Stacks 3.2 epoch start (bitcoin block <span id="block_target"></span>)
      is <span id="blocks_to_go"></span> blocks away.
    </p>
    <p></p>
    <p>
      That many blocks ago was height = <span id="used_block"></span> which
      occured at <span id="used_block_time"></span>,
      <span id="time_ago"></span> hours ago.
    </p>
  </div>

  <script>
    const HEIGHT_3_2 = 907740;
    const mainEndpoint = "https://api.blockcypher.com/v1/btc/main";

    async function main() {
      const current = await (await fetch(mainEndpoint)).json();
      const current_height = current.height;
      const current_date = new Date(current.time);

      if (current_height >= HEIGHT_3_2) {
        document.getElementById("main").innerHTML = `Stacks 3.2 epoch height reached!`;
      } else {
        const approximation_height =
          current_height - (HEIGHT_3_2 - current_height);
        const second_approximation_height =
          current_height - 4 * (HEIGHT_3_2 - current_height);

        // fire off the two requests in parallel
        const [prior, second_prior] = await Promise.all([
          fetch(`${mainEndpoint}/blocks/${approximation_height}?txstart=1&limit=1`).then(r => r.json()),
          fetch(`${mainEndpoint}/blocks/${second_approximation_height}?txstart=1&limit=1`).then(r => r.json()),
        ]);

        const prior_date = new Date(prior.time);
        const second_prior_date = new Date(second_prior.time);

        const seconds_delta = current_date - prior_date;
        const second_seconds_delta = (current_date - second_prior_date) / 4;
        const expected_seconds_delta =
          (seconds_delta + second_seconds_delta) / 2;

        const expected_date = new Date(
          current_date.getTime() + expected_seconds_delta,
        );

        document.getElementById("block_target").innerHTML = `<b>${HEIGHT_3_2}</b>`;
        document.getElementById("current_block").innerHTML = `<b>${current_height}</b>`;

        document.getElementById("expected_date").innerHTML = `<b>${expected_date}</b>`;
        document.getElementById("blocks_to_go").innerHTML = `<b>${HEIGHT_3_2 - current_height}</b>`;
        document.getElementById("used_block").innerHTML = `<b>${approximation_height}</b>`;
        document.getElementById("used_block_time").innerHTML = `<b>${prior_date}</b>`;
        document.getElementById("time_ago").innerHTML = `<b>${Math.floor(seconds_delta / 3600.0 / 10) / 100.0}</b>`;
      }

      // handle loading state by just hidding/showing #main
      document.getElementById("main").removeAttribute("hidden");
    }
    main()
  </script>
</body>

</html>

